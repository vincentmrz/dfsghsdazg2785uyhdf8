<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi Muscu – Programme Coach Ultime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --surface: #020617;
      --surface-soft: #030816;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: #22c55e;
      --text: #e5e7eb;
      --muted: #cbd5f5;
      --danger: #ef4444;
      --border: #111827;
      --border-soft: #0b1220;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.8);
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #020617 0, #000 70%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 520px;
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 16px 20px;
      border: 1px solid var(--border-soft);
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(34,197,94,0.14), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(59,130,246,0.10), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .app-inner {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-soft);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      font-size: 1.4rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .badge {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-size: 0.75rem;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.4);
      font-weight: 500;
      white-space: nowrap;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* CARDS */

    section.card {
      background: var(--surface-soft);
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .card-title-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: #f9fafb;
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .card-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      color: var(--muted);
      background: #020617;
      white-space: nowrap;
    }

    .card-tag span {
      color: var(--accent);
      font-weight: 600;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card-section {
      padding: 10px 10px 11px;
      border-radius: var(--radius-md);
      background: #020617;
      border: 1px solid rgba(15,23,42,0.7);
    }

    .card-section + .card-section {
      margin-top: 4px;
    }

    .section-title {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    /* FORM ELEMENTS */

    label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.16s, box-shadow 0.16s, background 0.16s;
    }

    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.6);
      background: #02091f;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > div {
      flex: 1;
    }

    .rest-info {
      font-size: 0.86rem;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.5;
    }

    .rest-info strong {
      color: #f9fafb;
      font-weight: 600;
    }

    /* BUTTONS */

    .btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 12px 16px;
      font-size: 0.9rem;
      font-weight: 650;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.08s ease-out, box-shadow 0.12s, background 0.12s, border-color 0.12s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #041007;
      box-shadow: 0 14px 30px rgba(22,163,74,0.55);
      border: 1px solid rgba(34,197,94,0.8);
    }

    .btn-primary:active {
      transform: scale(0.97) translateY(1px);
      box-shadow: 0 6px 18px rgba(22,163,74,0.6);
    }

    .btn-outline {
      background: #020617;
      color: var(--text);
      border: 1px solid var(--border-soft);
    }

    .btn-outline:active {
      transform: scale(0.98) translateY(1px);
    }

    .btn-sm {
      padding: 7px 10px;
      font-size: 0.8rem;
    }

    .btn-danger-active {
      border-color: var(--danger);
      color: #fecaca;
      background: rgba(239,68,68,0.12);
    }

    /* WARMUP / CARDIO BOX */

    .warmup-card {
      font-size: 0.86rem;
      color: var(--muted);
      padding: 9px 10px;
      border-radius: 12px;
      background: #020617;
      border: 1px dashed var(--border-soft);
      line-height: 1.5;
    }

    .warmup-card strong {
      color: #e5e7eb;
    }

    .warmup-card p + p {
      margin-top: 4px;
    }

    #edit-indicator {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
      text-align: center;
    }

    /* TIMER */

    .timer-display {
      font-variant-numeric: tabular-nums;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-align: center;
      margin-bottom: 6px;
      color: #f9fafb;
    }

    .timer-label {
      text-align: center;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .timer-controls {
      display: flex;
      gap: 8px;
    }

    .timer-controls .btn {
      flex: 1;
    }

    /* LOG LIST */

    .log-list {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 6px;
    }

    .log-item {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #020617;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .log-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .log-title {
      font-size: 0.86rem;
      color: #f9fafb;
    }

    .log-meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .log-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .log-tag {
      font-size: 0.8rem;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .log-edit-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--muted);
      font-size: 0.72rem;
      padding: 3px 7px;
      cursor: pointer;
    }

    .log-edit-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* PROGRESSION GRAPH */

    .progress-chart-wrapper {
      margin-top: 8px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid var(--border-soft);
      padding: 6px 6px 4px;
    }

    .progress-chart-placeholder {
      font-size: 0.82rem;
      color: var(--muted);
      text-align: center;
      padding: 10px 4px 6px;
    }

    #progress-chart svg {
      width: 100%;
      height: 150px;
      display: block;
    }

    @media (max-width: 480px) {
      .app {
        border-radius: 20px;
        padding: 14px 12px 18px;
      }

      h1 {
        font-size: 1.25rem;
      }

      .timer-display {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-inner">
      <header>
        <div class="title-block">
          <h1>Workout Tracker</h1>
          <div class="subtitle">Programme Coach Ultime – Muscu & Repos</div>
        </div>
        <div class="badge">Local • Offline • Perso</div>
      </header>

      <main>
        <!-- SÉLECTION SÉANCE / EXO + SAISIE SÉRIE -->
        <section class="card">
          <div class="card-header">
            <div class="card-title-group">
              <div class="card-title">Séance du jour</div>
              <div class="card-subtitle" id="today-label"></div>
            </div>
            <div class="card-tag">
              Jour <span id="day-chip">–</span>
            </div>
          </div>

          <div class="card-body">
            <div class="card-section">
              <div class="section-title">Sélection</div>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div>
                  <label for="workout-select">Séance</label>
                  <select id="workout-select"></select>
                </div>
                <div>
                  <label for="exercise-select">Exercice</label>
                  <select id="exercise-select"></select>
                  <div class="rest-info">
                    <strong>Repos :</strong> <span id="exercise-rest-label">–</span><br />
                    <strong>Cible :</strong> <span id="exercise-target-info">–</span><br />
                    <strong>Progression :</strong> <span id="exercise-sets-info">Séries terminées aujourd’hui : 0 / 0</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-section">
              <div class="section-title">Série en cours</div>
              <div class="row">
                <div>
                  <label for="weight-input">Poids (kg)</label>
                  <input id="weight-input" type="number" min="0" step="0.5" placeholder="ex: 80" />
                </div>
                <div>
                  <label for="reps-input">Reps</label>
                  <input id="reps-input" type="number" min="1" step="1" placeholder="ex: 8" />
                </div>
              </div>
              <div style="margin-top:10px;">
                <button id="log-set-btn" class="btn btn-primary">
                  Valider la série & lancer le repos
                </button>
                <button id="cancel-edit-btn" class="btn btn-outline btn-sm" style="margin-top:6px; display:none;">
                  Annuler la modification
                </button>
                <div id="edit-indicator" style="display:none;">
                  Mode édition : tu modifies une série de l'historique.
                </div>
              </div>
            </div>

            <div class="warmup-card" id="warmup-card">
              <p><strong>Échauffement :</strong> –</p>
              <p><strong>Cardio fin de séance :</strong> –</p>
            </div>
          </div>
        </section>

        <!-- TIMER DE REPOS -->
        <section class="card">
          <div class="card-header">
            <div class="card-title-group">
              <div class="card-title">Repos</div>
              <div class="card-subtitle">Chronomètre basé sur ton programme</div>
            </div>
          </div>
          <div class="card-body">
            <div class="timer-display" id="timer-display">00:00</div>
            <div class="timer-label" id="timer-label">Prêt à démarrer</div>
            <div class="timer-controls">
              <button id="restart-timer-btn" class="btn btn-outline btn-sm">
                Relancer le chrono
              </button>
              <button id="reset-timer-btn" class="btn btn-outline btn-sm">
                Stop / Reset
              </button>
            </div>
          </div>
        </section>

        <!-- HISTORIQUE JOURNÉE -->
        <section class="card">
          <div class="card-header">
            <div class="card-title-group">
              <div class="card-title">Historique du jour</div>
              <div class="card-subtitle">Séries enregistrées (stockées sur ton téléphone)</div>
            </div>
          </div>
          <div class="card-body">
            <div class="log-list" id="log-list"></div>
            <button id="clear-history-btn" class="btn btn-outline btn-sm" style="margin-top:8px;">
              Supprimer l'historique
            </button>
          </div>
        </section>

        <!-- PROGRESSION EXERCICE -->
        <section class="card">
          <div class="card-header">
            <div class="card-title-group">
              <div class="card-title">Progression de l'exercice</div>
              <div class="card-subtitle" id="progress-summary">
                Sélectionne un exercice pour voir l'évolution.
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="progress-chart-wrapper">
              <div id="progress-chart" class="progress-chart-placeholder">
                Pas encore de données pour cet exercice.
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ---------- DONNÉES PAR DÉFAUT : TON PROGRAMME COMPLET ----------
    const DEFAULT_DATA = {
      workouts: [
        {
          id: "lundi-upper-force",
          name: "Lundi – Upper Force",
          short: "Lun",
          warmup: "5–7 min rameur ou vélo léger + 2 séries de chauffe sur le développé couché (charges progressives).",
          cardio: "Pas de cardio programmé (self-défense ce jour).",
          exercises: [
            { id: "bench", name: "Développé couché barre", restSec: 180, sets: 5, repRange: "4 à 6", rir: "RIR 1–2" },
            { id: "pulldown-neutral", name: "Tirage vertical prise neutre poulie", restSec: 180, sets: 5, repRange: "4 à 6", rir: "RIR 1–2" },
            { id: "chest-press", name: "Presse poitrine horizontale convergente", restSec: 150, sets: 4, repRange: "6 à 8", rir: "RIR 1–2" },
            { id: "row-machine", name: "Rowing assis convergent poitrine appuyée", restSec: 150, sets: 4, repRange: "6 à 8", rir: "RIR 1–2" },
            { id: "shoulder-press", name: "Développé épaules machine convergente", restSec: 120, sets: 3, repRange: "6 à 8", rir: "RIR 1–2" },
            { id: "lat-raise-cable", name: "Élévations latérales poulie unilatérale", restSec: 75, sets: 3, repRange: "12 à 15", rir: "RIR 1–3" },
            { id: "pallof", name: "Gainage anti-rotation (Pallof press)", restSec: 45, sets: 3, repRange: "10 à 12", rir: "RIR 2–3" }
          ]
        },
        {
          id: "mardi-lower-force",
          name: "Mardi – Lower Force",
          short: "Mar",
          warmup: "5–7 min vélo + squats au poids du corps + 2 séries de chauffe à la hack squat.",
          cardio: "20 min marche sur tapis incliné ou vélo léger en fin de séance (zone 2, respiration un peu accélérée mais tu peux parler).",
          exercises: [
            { id: "hack-squat", name: "Hack squat (machine)", restSec: 180, sets: 5, repRange: "4 à 6", rir: "RIR 1–2" },
            { id: "rdl-db", name: "Soulevé de terre roumain haltères", restSec: 150, sets: 4, repRange: "6 à 8", rir: "RIR 1–2" },
            { id: "leg-press", name: "Presse à cuisses", restSec: 150, sets: 3, repRange: "6 à 8", rir: "RIR 1–2" },
            { id: "leg-curl", name: "Leg curl assis (machine)", restSec: 120, sets: 3, repRange: "8 à 10", rir: "RIR 1–2" },
            { id: "calf-press", name: "Mollets à la presse à cuisses", restSec: 90, sets: 4, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "cable-crunch", name: "Crunch à la poulie haute", restSec: 60, sets: 3, repRange: "12 à 15", rir: "RIR 2–3" }
          ]
        },
        {
          id: "mercredi-push-hypertrophy",
          name: "Mercredi – Push Hypertrophie",
          short: "Mer",
          warmup: "5 min cardio léger + mobilité épaules + 2 séries de chauffe à la presse poitrine.",
          cardio: "Optionnel : 10–15 min marche ou vélo très léger en fin de séance.",
          exercises: [
            { id: "chest-press-horiz", name: "Presse poitrine horizontale convergente", restSec: 150, sets: 4, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "incline-db", name: "Développé couché haltères incliné (20–30°)", restSec: 120, sets: 3, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "dips", name: "Dips buste penché", restSec: 150, sets: 3, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "shoulder-press-machine", name: "Développé épaules machine convergente", restSec: 120, sets: 3, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "lat-raise-cable-high", name: "Élévations latérales poulie unilatérale", restSec: 75, sets: 4, repRange: "12 à 20", rir: "RIR 1–3" },
            { id: "cable-fly", name: "Écartés aux câbles (debout au centre)", restSec: 75, sets: 3, repRange: "12 à 15", rir: "RIR 1–2" },
            { id: "triceps-rope", name: "Extension triceps à la corde poulie", restSec: 60, sets: 3, repRange: "10 à 15", rir: "RIR 1–2" }
          ]
        },
        {
          id: "jeudi-pull-hypertrophy",
          name: "Jeudi – Pull Hypertrophie",
          short: "Jeu",
          warmup: "5 min cardio léger + 2 séries de tirage vertical très léger.",
          cardio: "Pas de cardio programmé (self-défense ce jour).",
          exercises: [
            { id: "pulldown-neutral-hyp", name: "Tirage vertical prise neutre poulie", restSec: 150, sets: 4, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "row-machine-hyp", name: "Rowing assis convergent poitrine appuyée", restSec: 150, sets: 4, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "onearm-cable-row", name: "Rowing unilatéral à la poulie (basse)", restSec: 120, sets: 3, repRange: "10 à 12", rir: "RIR 1–2" },
            { id: "rear-delt-cable", name: "Oiseau à la poulie", restSec: 60, sets: 3, repRange: "15 à 20", rir: "RIR 1–3" },
            { id: "curl-ez", name: "Curl barre EZ debout", restSec: 120, sets: 3, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "curl-cable", name: "Curl à la poulie basse", restSec: 75, sets: 3, repRange: "10 à 15", rir: "RIR 1–2" },
            { id: "face-pull", name: "Face pull corde poulie", restSec: 60, sets: 3, repRange: "15 à 20", rir: "RIR 1–3" }
          ]
        },
        {
          id: "vendredi-legs-shoulders",
          name: "Vendredi – Legs & Shoulders Hypertrophie",
          short: "Ven",
          warmup: "5–7 min cardio léger + squats à vide + 2 séries de chauffe à la presse à cuisses.",
          cardio: "25–30 min marche sur tapis incliné en fin de séance (zone 2, tranquille mais continu).",
          exercises: [
            { id: "leg-press-hyp", name: "Presse à cuisses", restSec: 150, sets: 4, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "bulgarian-split", name: "Fentes bulgares haltères", restSec: 150, sets: 3, repRange: "10 à 12", rir: "RIR 1–2" },
            { id: "leg-curl-hyp", name: "Leg curl assis (machine)", restSec: 120, sets: 3, repRange: "10 à 15", rir: "RIR 1–2" },
            { id: "hip-thrust", name: "Hip thrust barre sur banc", restSec: 150, sets: 3, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "calf-seated", name: "Mollets assis (machine)", restSec: 75, sets: 4, repRange: "12 à 15", rir: "RIR 1–2" },
            { id: "shoulder-press-hyp", name: "Développé épaules machine convergente", restSec: 120, sets: 3, repRange: "8 à 12", rir: "RIR 1–2" },
            { id: "lat-raise-partials", name: "Élévations latérales poulie – partiels", restSec: 60, sets: 2, repRange: "10–12 + 5–10 partiels", rir: "RIR 1–3" }
          ]
        }
      ]
    };

    const STORAGE_KEY_DATA = "coachUltimeGymData";
    const STORAGE_KEY_LOGS = "coachUltimeGymLogs";

    let appData;
    let logs;

    function loadState() {
      try {
        const storedData = localStorage.getItem(STORAGE_KEY_DATA);
        const storedLogs = localStorage.getItem(STORAGE_KEY_LOGS);
        appData = storedData ? JSON.parse(storedData) : DEFAULT_DATA;
        logs = storedLogs ? JSON.parse(storedLogs) : {};
      } catch (e) {
        console.error("Erreur chargement stockage local", e);
        appData = DEFAULT_DATA;
        logs = {};
      }
    }

    function saveLogs() {
      localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(logs));
    }

    function getTodayKey() {
      const d = new Date();
      return d.toISOString().split("T")[0];
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function secondsToText(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      if (m > 0 && s > 0) return `${m} min ${s} s`;
      if (m > 0) return `${m} min`;
      return `${s} s`;
    }

    function getWorkoutById(id) {
      return appData.workouts.find(w => w.id === id);
    }

    function getExerciseById(workout, exerciseId) {
      if (!workout) return null;
      return workout.exercises.find(e => e.id === exerciseId);
    }

    const workoutSelect = document.getElementById("workout-select");
    const exerciseSelect = document.getElementById("exercise-select");
    const exerciseRestLabel = document.getElementById("exercise-rest-label");
    const exerciseTargetInfo = document.getElementById("exercise-target-info");
    const exerciseSetsInfo = document.getElementById("exercise-sets-info");
    const weightInput = document.getElementById("weight-input");
    const repsInput = document.getElementById("reps-input");
    const logList = document.getElementById("log-list");
    const todayLabel = document.getElementById("today-label");
    const dayChip = document.getElementById("day-chip");
    const progressChart = document.getElementById("progress-chart");
    const progressSummary = document.getElementById("progress-summary");
    const clearHistoryBtn = document.getElementById("clear-history-btn");
    const warmupCard = document.getElementById("warmup-card");

    const timerDisplay = document.getElementById("timer-display");
    const timerLabel = document.getElementById("timer-label");
    const logSetBtn = document.getElementById("log-set-btn");
    const restartTimerBtn = document.getElementById("restart-timer-btn");
    const resetTimerBtn = document.getElementById("reset-timer-btn");

    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const editIndicator = document.getElementById("edit-indicator");

    let timerId = null;
    let timerRemaining = 0;
    let clearConfirm = false;
    let clearConfirmTimeout = null;

    let editingEntry = null; // {dayKey, index}
    const defaultBtnText = "Valider la série & lancer le repos";
    const editBtnText = "Mettre à jour la série";

    function initTodayUI() {
      const d = new Date();
      const days = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
      const shortDays = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
      todayLabel.textContent = days[d.getDay()];
      dayChip.textContent = shortDays[d.getDay()];
    }

    function populateWorkoutSelect() {
      workoutSelect.innerHTML = "";
      appData.workouts.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w.id;
        opt.textContent = w.name;
        workoutSelect.appendChild(opt);
      });

	  const d = new Date();
	  const idx = d.getDay();
	  let defaultId = null;
	  if (idx >= 1 && idx <= 5 && appData.workouts[idx - 1]) {
		defaultId = appData.workouts[idx - 1].id;
	  }
	  if (defaultId) workoutSelect.value = defaultId;
    }

    function populateExerciseSelect() {
      exerciseSelect.innerHTML = "";
      const workout = getWorkoutById(workoutSelect.value);
      if (!workout) return;

      workout.exercises.forEach(ex => {
        const opt = document.createElement("option");
        opt.value = ex.id;
        opt.textContent = ex.name;
        exerciseSelect.appendChild(opt);
      });

      updateWorkoutMeta();
      updateExerciseMeta();
    }

    function updateWorkoutMeta() {
      const workout = getWorkoutById(workoutSelect.value);
      if (!workout) {
        warmupCard.innerHTML =
          "<p><strong>Échauffement :</strong> –</p><p><strong>Cardio fin de séance :</strong> –</p>";
        return;
      }
      warmupCard.innerHTML =
        `<p><strong>Échauffement :</strong> ${workout.warmup}</p>` +
        `<p><strong>Cardio fin de séance :</strong> ${workout.cardio}</p>`;
    }

    function updateExerciseMeta() {
      const workout = getWorkoutById(workoutSelect.value);
      const exercise = getExerciseById(workout, exerciseSelect.value);

      if (!exercise) {
        exerciseRestLabel.textContent = "–";
        exerciseTargetInfo.textContent = "–";
        exerciseSetsInfo.textContent = "Séries terminées aujourd’hui : 0 / 0";
        exerciseSetsInfo.style.color = "var(--muted)";
        renderExerciseProgress();
        return;
      }

      exerciseRestLabel.textContent = secondsToText(exercise.restSec);

      const target = exercise.sets || 0;
      const rr = exercise.repRange || "–";
      const rir = exercise.rir || "RIR ?";
      exerciseTargetInfo.textContent =
        `${target} séries • ${rr} reps • ${rir}`;

      const dayKey = getTodayKey();
      const dayLogs = logs[dayKey] || [];
      const done = dayLogs.filter(
        l => l.workoutId === workout.id && l.exerciseId === exercise.id
      ).length;

      exerciseSetsInfo.textContent =
        `Séries terminées aujourd’hui : ${done} / ${target}`;

      if (target > 0 && done >= target) {
        exerciseSetsInfo.style.color = "#22c55e";
      } else {
        exerciseSetsInfo.style.color = "var(--muted)";
      }

      renderExerciseProgress();
    }

    function renderTodayLogs() {
      const dayKey = getTodayKey();
      const dayLogs = logs[dayKey] || [];
      logList.innerHTML = "";

      if (dayLogs.length === 0) {
        const empty = document.createElement("div");
        empty.className = "card-subtitle";
        empty.textContent = "Aucune série enregistrée pour le moment.";
        logList.appendChild(empty);
        return;
      }

      const entries = dayLogs.map((entry, index) => ({ entry, index }));

      entries.slice().reverse().forEach(({ entry, index }) => {
        const item = document.createElement("div");
        item.className = "log-item";

        const main = document.createElement("div");
        main.className = "log-main";

        const title = document.createElement("div");
        title.className = "log-title";
        title.textContent = `${entry.workoutName} – ${entry.exerciseName}`;

        const meta = document.createElement("div");
        meta.className = "log-meta";
        const weightText = entry.weight ? `${entry.weight} kg` : "Poids non renseigné";
        const repsText = entry.reps ? `${entry.reps} reps` : "Reps non renseignées";
        meta.textContent = `Série ${entry.setNumber} • ${weightText} • ${repsText}`;

        main.appendChild(title);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "log-actions";

        const tag = document.createElement("div");
        tag.className = "log-tag";
        tag.textContent = formatTime(entry.restSec || 0);

        const editBtn = document.createElement("button");
        editBtn.className = "log-edit-btn";
        editBtn.textContent = "Modifier";
        editBtn.dataset.index = String(index);

        actions.appendChild(tag);
        actions.appendChild(editBtn);

        item.appendChild(main);
        item.appendChild(actions);
        logList.appendChild(item);
      });
    }

    function renderExerciseProgress() {
      const workout = getWorkoutById(workoutSelect.value);
      const exercise = getExerciseById(workout, exerciseSelect.value);

      progressChart.innerHTML = "";

      if (!workout || !exercise) {
        progressChart.className = "progress-chart-placeholder";
        progressChart.textContent = "Sélectionne un exercice.";
        progressSummary.textContent = "Sélectionne un exercice pour voir l'évolution.";
        return;
      }

      progressChart.className = "";
      const allPoints = [];
      for (const [dayKey, dayLogs] of Object.entries(logs)) {
        const exLogs = dayLogs.filter(
          l => l.workoutId === workout.id && l.exerciseId === exercise.id
        );
        if (exLogs.length > 0) {
          const bestWeight = Math.max(...exLogs.map(l => l.weight || 0));
          allPoints.push({ dayKey, bestWeight });
        }
      }

      if (allPoints.length === 0) {
        progressChart.className = "progress-chart-placeholder";
        progressChart.textContent = "Pas encore de données pour cet exercice.";
        progressSummary.textContent = "Enregistre quelques séances pour voir la progression.";
        return;
      }

      allPoints.sort((a, b) => a.dayKey.localeCompare(b.dayKey));
      const last = allPoints[allPoints.length - 1];

      progressSummary.innerHTML =
        `Dernière séance : <strong>${last.bestWeight} kg</strong> (meilleure série)` +
        `<br>Nombre de séances enregistrées : ${allPoints.length}`;

      const width = 320;
      const height = 150;
      const margin = 26;

      const weights = allPoints.map(p => p.bestWeight || 0);
      const minW = Math.min(...weights);
      const maxW = Math.max(...weights);
      const wRange = maxW - minW || 1;

      const xStep = allPoints.length > 1
        ? (width - 2 * margin) / (allPoints.length - 1)
        : 0;

      const points = allPoints.map((p, i) => {
        const x = margin + i * xStep;
        const norm = (p.bestWeight - minW) / wRange;
        const y = height - margin - norm * (height - 2 * margin);
        return { x, y, ...p };
      });

      let polylinePoints = points.map(p => `${p.x},${p.y}`).join(" ");

      let svg = `<svg viewBox="0 0 ${width} ${height}">`;

      svg += `
        <line x1="${margin}" y1="${height - margin}" x2="${width - margin}" y2="${height - margin}"
          stroke="rgba(148,163,184,0.5)" stroke-width="1" />
        <line x1="${margin}" y1="${margin}" x2="${margin}" y2="${height - margin}"
          stroke="rgba(148,163,184,0.5)" stroke-width="1" />
      `;

      if (points.length > 1) {
        svg += `
          <polyline
            points="${polylinePoints}"
            fill="none"
            stroke="rgba(34,197,94,0.9)"
            stroke-width="2"
          />
        `;
      }

      points.forEach(p => {
        const [year, month, day] = p.dayKey.split("-");
        const dateShort = `${day}/${month}`;

        svg += `<circle cx="${p.x}" cy="${p.y}" r="3" fill="#22c55e" />`;
        svg += `
          <text x="${p.x}" y="${height - margin + 13}"
            font-size="9" text-anchor="middle" fill="rgba(148,163,184,0.95)">
            ${dateShort}
          </text>
        `;
      });

      svg += `
        <text x="${margin - 6}" y="${height - margin}" font-size="9" text-anchor="end" fill="rgba(148,163,184,0.95)">
          ${minW} kg
        </text>
        <text x="${margin - 6}" y="${margin + 4}" font-size="9" text-anchor="end" fill="rgba(148,163,184,0.95)">
          ${maxW} kg
        </text>
      `;

      svg += `</svg>`;
      progressChart.innerHTML = svg;
    }

    function updateTimerUI() {
      timerDisplay.textContent = formatTime(timerRemaining);
      if (timerRemaining > 0) {
        timerLabel.textContent = "Repos en cours…";
      } else {
        timerLabel.textContent = "Repos terminé ou en attente";
      }
    }

    function startTimer(seconds) {
      if (timerId) clearInterval(timerId);
      timerRemaining = seconds;
      updateTimerUI();

      if (seconds <= 0) return;

      timerId = setInterval(() => {
        timerRemaining--;
        if (timerRemaining <= 0) {
          timerRemaining = 0;
          clearInterval(timerId);
          timerId = null;
          timerLabel.textContent = "Repos terminé ✔";
        }
        updateTimerUI();
      }, 1000);
    }

    function resetTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      timerRemaining = 0;
      updateTimerUI();
    }

    function enterEditMode(dayKey, index, entry) {
      editingEntry = { dayKey, index };

      // Replacer la séance / exercice + poids / reps
      workoutSelect.value = entry.workoutId;
      populateExerciseSelect();
      exerciseSelect.value = entry.exerciseId;
      updateExerciseMeta();
	  weightInput.value =
		(entry.weight !== undefined && entry.weight !== null) ? entry.weight : "";
	  repsInput.value =
		(entry.reps !== undefined && entry.reps !== null) ? entry.reps : "";

      // UI
      logSetBtn.textContent = editBtnText;
      cancelEditBtn.style.display = "inline-flex";
      editIndicator.style.display = "block";
    }

    function exitEditMode() {
      editingEntry = null;
      logSetBtn.textContent = defaultBtnText;
      cancelEditBtn.style.display = "none";
      editIndicator.style.display = "none";
      // On ne vide pas forcément les champs, tu peux les réutiliser si tu veux
    }

    function handleLogSet() {
      const workout = getWorkoutById(workoutSelect.value);
      const exercise = getExerciseById(workout, exerciseSelect.value);
      if (!workout || !exercise) return;

      const weight = weightInput.value ? Number(weightInput.value) : null;
      const reps = repsInput.value ? Number(repsInput.value) : null;

      // MODE ÉDITION : on met juste à jour la série existante
      if (editingEntry) {
        const { dayKey, index } = editingEntry;
        const dayLogs = logs[dayKey] || [];
        const entry = dayLogs[index];
        if (!entry) {
          exitEditMode();
          return;
        }

        entry.workoutId = workout.id;
        entry.workoutName = workout.name;
        entry.exerciseId = exercise.id;
        entry.exerciseName = exercise.name;
        entry.weight = weight;
        entry.reps = reps;
        entry.restSec = exercise.restSec;

        saveLogs();
        renderTodayLogs();
        updateExerciseMeta();
        startTimer(exercise.restSec);
        exitEditMode();
        return;
      }

      // MODE NORMAL : on ajoute une nouvelle série
      const dayKey = getTodayKey();
      if (!logs[dayKey]) logs[dayKey] = [];
      const existingSets = logs[dayKey].filter(
        l => l.exerciseId === exercise.id && l.workoutId === workout.id
      );
      const setNumber = existingSets.length + 1;

      const entry = {
        ts: new Date().toISOString(),
        workoutId: workout.id,
        workoutName: workout.name,
        exerciseId: exercise.id,
        exerciseName: exercise.name,
        setNumber,
        weight,
        reps,
        restSec: exercise.restSec
      };

      logs[dayKey].push(entry);
      saveLogs();
      renderTodayLogs();

      startTimer(exercise.restSec);

      const targetSets = exercise.sets || 0;
      const completedSets = setNumber;
      let advanced = false;
      if (targetSets > 0 && completedSets >= targetSets) {
        const idx = workout.exercises.findIndex(ex => ex.id === exercise.id);
        if (idx >= 0 && idx < workout.exercises.length - 1) {
          const nextEx = workout.exercises[idx + 1];
          exerciseSelect.value = nextEx.id;
          advanced = true;
        }
      }

      if (advanced) {
        weightInput.value = "";
        repsInput.value = "";
      } else {
        repsInput.value = "";
      }

      updateExerciseMeta();
    }

    function handleRestartTimer() {
      const workout = getWorkoutById(workoutSelect.value);
      const exercise = getExerciseById(workout, exerciseSelect.value);
      if (!exercise) return;
      startTimer(exercise.restSec);
    }

    function handleResetTimer() {
      resetTimer();
    }

    function handleClearHistory() {
      if (!clearConfirm) {
        clearConfirm = true;
        clearHistoryBtn.textContent = "Confirmer la suppression";
        clearHistoryBtn.classList.add("btn-danger-active");
        if (clearConfirmTimeout) clearTimeout(clearConfirmTimeout);
        clearConfirmTimeout = setTimeout(() => {
          clearConfirm = false;
          clearHistoryBtn.textContent = "Supprimer l'historique";
          clearHistoryBtn.classList.remove("btn-danger-active");
        }, 5000);
        return;
      }

      clearConfirm = false;
      if (clearConfirmTimeout) {
        clearTimeout(clearConfirmTimeout);
        clearConfirmTimeout = null;
      }
      logs = {};
      saveLogs();
      renderTodayLogs();
      updateExerciseMeta();
      exitEditMode();
      clearHistoryBtn.textContent = "Supprimer l'historique";
      clearHistoryBtn.classList.remove("btn-danger-active");
    }

    function init() {
      loadState();
      initTodayUI();
      populateWorkoutSelect();
      populateExerciseSelect();
      renderTodayLogs();
      updateTimerUI();
      renderExerciseProgress();

      workoutSelect.addEventListener("change", () => {
        populateExerciseSelect();
      });

      exerciseSelect.addEventListener("change", () => {
        updateExerciseMeta();
      });

      logSetBtn.addEventListener("click", handleLogSet);
      restartTimerBtn.addEventListener("click", handleRestartTimer);
      resetTimerBtn.addEventListener("click", handleResetTimer);
      clearHistoryBtn.addEventListener("click", handleClearHistory);

      cancelEditBtn.addEventListener("click", () => {
        exitEditMode();
      });

      // clic sur "Modifier" dans l'historique (event delegation)
      logList.addEventListener("click", (e) => {
        const btn = e.target.closest(".log-edit-btn");
        if (!btn) return;
        const index = Number(btn.dataset.index);
        const dayKey = getTodayKey();
        const dayLogs = logs[dayKey] || [];
        const entry = dayLogs[index];
        if (!entry) return;
        enterEditMode(dayKey, index, entry);
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
